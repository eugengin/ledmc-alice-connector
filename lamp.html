<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>LED-MC Voice Disk</title>
<style>
  body { background:#111; color:#eee; text-align:center; font-family:Arial; }
  canvas { margin-top:40px; }
  #log { width:80%; height:150px; margin:20px auto; background:#000; color:#0f0; padding:10px; overflow-y:auto; text-align:left; }
  button { margin:10px; padding:10px 20px; font-size:16px; border:none; border-radius:6px; cursor:pointer; }
  #startBtn { background:#ffa500; }
  #stopBtn { background:#f00; color:#fff; }
</style>
</head>
<body>
<h2>üü° LED-MC Disk ‚Äî –≥–æ–ª–æ—Å–æ–≤–æ–π –∫–æ–Ω–Ω–µ–∫—Ç–æ—Ä</h2>
<canvas id="disc" width="340" height="340"></canvas><br>
<button id="startBtn">üéô –ì–æ–≤–æ—Ä–∏—Ç—å</button>
<button id="stopBtn">üõë –°—Ç–æ–ø</button>
<div id="log"></div>

<script>
const log = msg => {
  const l = document.getElementById("log");
  l.innerHTML += msg + "<br>";
  l.scrollTop = l.scrollHeight;
};

// --- –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –¥–∏—Å–∫–∞ ---
const canvas = document.getElementById('disc');
const ctx = canvas.getContext('2d');
function drawDisc(bright=60, hue=40) {
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.beginPath();
  ctx.arc(170,170,160,0,2*Math.PI);
  ctx.fillStyle="#222";
  ctx.fill();
  ctx.strokeStyle=`hsl(${hue},90%,${30+bright/2}%)`;
  ctx.lineWidth=6;
  ctx.shadowColor=`hsl(${hue},90%,${60}%)`;
  ctx.shadowBlur=bright/2;
  ctx.stroke();
}
drawDisc();

// --- Speech Recognition ---
let recognition;
if ('webkitSpeechRecognition' in window) {
  recognition = new webkitSpeechRecognition();
  recognition.lang = "ru-RU";
  recognition.continuous = true;
  recognition.interimResults = false;
  recognition.onresult = async event => {
    const text = event.results[event.results.length-1][0].transcript.trim();
    log("üé§ " + text);
    try {
      const res = await fetch("/api/lamp", {   // ‚Üê –Ω–æ–≤—ã–π endpoint
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ message: text }) // ‚Üê –Ω–æ–≤–æ–µ –ø–æ–ª–µ message
      });
      const data = await res.json();
      if(data.ok && data.lamp){
        const lamp = data.lamp;
        drawDisc(lamp.brightness||60, lamp.hue||40);
        log("ü§ñ say: " + (lamp.say||"") + " | brightness: " + (lamp.brightness||"") + " | hue: " + (lamp.hue||"") + " | mode: " + (lamp.mode||""));
      } else {
        log("‚ùå –û—à–∏–±–∫–∞ API: " + (data.error||"–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è"));
      }
    } catch(e){ log("‚ùå –û—à–∏–±–∫–∞: " + e.message); }
  };
}

// --- –∫–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è ---
document.getElementById('startBtn').onclick = ()=> { recognition?.start(); log("–ì–æ–ª–æ—Å: —Å—Ç–∞—Ä—Ç"); };
document.getElementById('stopBtn').onclick = ()=> { recognition?.stop(); log("–ì–æ–ª–æ—Å: —Å—Ç–æ–ø"); };

</script>
</body>
</html>
